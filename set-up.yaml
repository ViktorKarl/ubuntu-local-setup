---
- name: Complete Ubuntu Environment Setup
  hosts: localhost
  connection: local
  become: true
  vars:
    target_user: "{{ ansible_facts.env.SUDO_USER | default(lookup('env', 'USER')) }}"
    target_home: "/home/{{ target_user }}"

  tasks:
    # â”€â”€ System Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Update apt cache
      apt:
        update_cache: yes

    # â”€â”€ CLI Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install Podman, CLI tools, and developer utilities
      apt:
        pkg:
          - tree
          - fzf
          - htop
          - curl
          - git
          - wget
          - gpg
          - ca-certificates
          - jq               # JSON processor
          - yq               # YAML processor
          - ripgrep           # fast recursive grep (rg)
          - bat               # cat with syntax highlighting
          - unzip
          - net-tools         # ifconfig, netstat, etc.
          - shellcheck        # shell script linter
          - tmux              # terminal multiplexer
          - bash-completion   # programmable completion framework
        state: present

    # â”€â”€ VS Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install VS Code (Native Ubuntu Support)
      block:
        - name: Download VS Code GPG key (armored)
          get_url:
            url: https://packages.microsoft.com/keys/microsoft.asc
            dest: /tmp/microsoft.asc
            mode: '0644'

        - name: Dearmor VS Code GPG key
          shell: gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg /tmp/microsoft.asc
          args:
            creates: /etc/apt/keyrings/microsoft.gpg

        - name: Add VS Code Repository
          apt_repository:
            repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
            state: present
            filename: vscode

        - name: Install VS Code
          apt:
            name: code
            update_cache: yes
            state: present

    # â”€â”€ Shell Configuration (run as target user) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check if fzf keybindings file exists
      stat:
        path: /usr/share/doc/fzf/examples/key-bindings.bash
      register: fzf_keybindings

    - name: Enable fzf keybindings
      lineinfile:
        path: "{{ target_home }}/.bashrc"
        line: "source /usr/share/doc/fzf/examples/key-bindings.bash"
        create: yes
      become: false
      when: fzf_keybindings.stat.exists

    - name: Add useful bash aliases
      blockinfile:
        path: "{{ target_home }}/.bashrc"
        marker: "# {mark} ANSIBLE MANAGED ALIASES"
        block: |
          alias ll='ls -alF'
          alias g='git'
          alias t='terraform'
          alias k='kubectl'
          alias sysupdate='echo "ğŸ”„ Running: sudo apt update" && sudo apt update && \
          echo "â¬†ï¸ Running: sudo apt full-upgrade -y" && sudo apt full-upgrade -y && \
          echo "ğŸ§¹ Running: sudo apt autoremove -y" && sudo apt autoremove -y && \
          echo "ğŸ§¼ Running: sudo apt autoclean" && sudo apt autoclean && \
          echo "âœ… System update complete."'
          export EDITOR=code
      become: false

    # â”€â”€ Tab Completion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Add base completions to bashrc
      blockinfile:
        path: "{{ target_home }}/.bashrc"
        marker: "# {mark} ANSIBLE MANAGED COMPLETIONS"
        block: |
          # Enable bash-completion if not already loaded
          if [ -f /usr/share/bash-completion/bash_completion ]; then
            . /usr/share/bash-completion/bash_completion
          fi
          # git completion (shipped with git package)
          if [ -f /usr/share/bash-completion/completions/git ]; then
            . /usr/share/bash-completion/completions/git
            __git_complete g __git_main
          fi
      become: false

    # â”€â”€ Git default config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Set git default branch name
      community.general.git_config:
        name: init.defaultBranch
        value: main
        scope: global
      become: true
      become_user: "{{ target_user }}"

    - name: Set git user name
      community.general.git_config:
        name: user.name
        value: "ViktorKarl"
        scope: global
      become: true
      become_user: "{{ target_user }}"

    - name: Set git user email
      community.general.git_config:
        name: user.email
        value: "viktorkg98@gmail.com"
        scope: global
      become: true
      become_user: "{{ target_user }}"
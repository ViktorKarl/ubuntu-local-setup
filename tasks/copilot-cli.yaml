---
# ── GitHub Copilot CLI (gh extension) ───────────────────────
# In newer gh versions, `copilot` is a built-in command and the extension
# install will fail with "matches the name of a built-in command or alias".
# We check first and only install the extension when it isn't built-in.

- name: Check if gh-copilot extension is installed
  shell: gh extension list | grep -q gh-copilot
  register: gh_copilot_check
  changed_when: false
  failed_when: false
  become: true
  become_user: "{{ target_user }}"
  environment:
    GH_TOKEN: "{{ lookup('env', 'GH_TOKEN') | default('', true) }}"

- name: Install GitHub Copilot extension for gh CLI
  command: gh extension install github/gh-copilot
  args:
    creates: "{{ target_home }}/.local/share/gh/extensions/gh-copilot"
  become: true
  become_user: "{{ target_user }}"
  environment:
    GH_TOKEN: "{{ lookup('env', 'GH_TOKEN') | default('', true) }}"
  when: gh_copilot_check.rc != 0
